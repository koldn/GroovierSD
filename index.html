<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Groovier SD</title>

        <meta name="description" content="Groovier SD">
        <meta name="author" content="Dmitriy Kolmogortsev">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/beige.css" id="theme">

        <link rel="stylesheet" href="css/hljs/vs.css" id="highlight-theme">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->

        <style>
.reveal .slide-number {
    font-size:22pt;
    color:black;
}

.reveal pre {
    background: none;
    border: none;
    box-shadow: none;
}

.reveal pre code{
    color: black;
    background: none;
    box-shadow: none;
    max-height: none;
}

.reveal section img {
    border: none;
    box-shadow: none;
}

.reveal pre code {
    overflow: hidden;
    height: 100%;
    width: 100%;
}

.reveal .footer {
	font-size:22pt;
	color:black;

	position: absolute;
	left: 35%;
	bottom: 0.5em;
}
        </style>
    </head>

    <body>

        <div class="reveal">
            <div class="footer">
                NAUMEN, –ö–æ–ª–º–æ–≥–æ—Ä—Ü–µ–≤ –î–º–∏—Ç—Ä–∏–π
            </div>
            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">
                <section>
                    <h2>Groovier SD4</h2>
                    <p>
                        <small>
                        –ö–æ–ª–º–æ–≥–æ—Ä—Ü–µ–≤ –î–º–∏—Ç—Ä–∏–π / <a href="mailto:dkolmogortsev@naumen.ru">dkolmogortsev@naumen.ru</a>
                        <br/>
                        <br/>
                        </small>
                    </p>
                </section>
                <section>
                    <h2>SD4 Experience</h2>
                </section>
                <section>
                  <h2>Groovy + SD = üíï</h2>
                </section>
                <section>
                  <h2>A long time ago in a galaxy far, far away...</h2>
                </section>
                <section>
                  <h3>Java 8 migration</h3>
                  <ul>
                    <li class="fragment">OOM Killer
                    <li class="fragment">Native memory allocation (malloc) failed to allocate...
                  </ul>
                </section>
                <section data-background-image="img/groovy.gif">
                </section>
                <section>
                  <h2>JSR223 Leaks!</h2>
                  <ul>
                      <li><a href="https://issues.apache.org/jira/browse/GROOVY-7683">GROOVY-7683:Memory leak when using Groovy as JSR-223 scripting language.</a>
                      <li>7.400 GroovyClassLoaders –≤ —Ö–∏–ø–µ
                  </ul>
                </section>
                <section>
                	<h2>Meanwhile...</h2>
                    <ul>
                        <li class="fragment">–ü–æ—è–≤–∏–ª—Å—è –±–æ–ª—å—à–æ–π –∫–ª–∏–µ–Ω—Ç, –≥–¥–µ –º–Ω–æ–≥–æ–µ —Å–¥–µ–ª–∞–Ω–æ —Å–∫—Ä–∏–ø—Ç–∞–º–∏
                        <li class="fragment">–ü—Ä–∏ –ø—Ä–æ—Å—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ ~5000 –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π —Å–∫—Ä–∏–ø—Ç–æ–≤
                        <li class="fragment">Java 7, though
                        <li class="fragment">Let`s see what we can do
                    </ul>
                </section>
                <section>
                    <h2>Groovy from java bench</h2>
                    <pre><code data-trim class="java">@BenchmarkMode(value = Mode.Throughput)
@Warmup(iterations = 4, time = 20, timeUnit = TimeUnit.SECONDS)
@Measurement(iterations = 8, time = 20, timeUnit = TimeUnit.SECONDS)
@Fork(4)
@Threads(8)</code></pre>
                </section>
                <section>
                  <h2>Bench:script</h2>
                  <p>SimpleScript.groovy</p>
                  <pre><code data-trim class="groovy">
import static java.lang.Math.PI

def a = 10.25;
def b = 2;
def x = 122;
def y = a * x + b + (key * PI);
return y;
                  </code></pre>
                </section>
                <section>
                  <h2>JSR223 example</h2>
                  <pre><code data-trim class="java">
String simpleScriptBody;
try (InputStream is = GroovyShellExample.class.getClassLoader()
    .getResourceAsStream("SimpleScript.groovy"))
{
  simpleScriptBody = IOUtils.toString(is, "UTF-8");
}
ScriptEngineManager engineManager = new ScriptEngineManager();
ScriptEngine engine = engineManager.getEngineByName("groovy");
CompiledScript script = ((Compilable) (engine)).compile(simpleScriptBody);

Bindings bindings = new SimpleBindings();
bindings.put("key", 123L);

SimpleScriptContext ctx = new SimpleScriptContext();
ctx.setBindings(bindings, ScriptContext.ENGINE_SCOPE);

System.out.println(script.eval(ctx));
                  </code></pre>
                </section>
                <section>
                  <h2>GroovyShell example</h2>
                  <pre><code data-trim class="java">
String simpleScriptBody;
try (InputStream is = GroovyShellExample.class.getClassLoader()
    .getResourceAsStream("SimpleScript.groovy"))
{
  simpleScriptBody = IOUtils.toString(is, "UTF-8");
}
GroovyShell shell = new GroovyShell();
Script script = shell.parse(simpleScriptBody);
script.setProperty("key", 123L);
System.out.println(script.run());
                  </code></pre>
                </section>
                <section>
                    <h2>Results</h2>
                    <p>–ë–æ–ª—å—à–µ - –ª—É—á—à–µ</p>
                    <table>
                        <tr>
                            <td>GroovyJSR223Benchmark</td>
                            <td>137030.242</td>
                            <td>op/s</td>
                        </tr>
                        <tr>
                            <td>GroovyShellBenchmark</td>
                            <td>4101902.557</td>
                            <td>op/s</td>
                        </tr>
                        <tr>
                            <td>IndyGroovyShellBenchmark</td>
                            <td>4734100.850</td>
                            <td>op/s</td>
                        </tr>
                    </table>
                    <a href="https://github.com/d0k1/groovy-eval-bench">more here</a>
                </section>

                <section data-background-image="img/wtf.gif">
                </section>
                <section>
                  <h2>Swap to GroovyShell</h2>
                  <p>–ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å ~5000 –≤—ã–∑–æ–≤–æ–≤ —Å–∫—Ä–∏–ø–æ–≤, ms</p>
                  <table>
                    <thead>
                      <th>Threads</th>
                      <th>JSR223</th>
                      <th>GroovyShell</th>
                    </thead>
                    <tbody>
                      <tr>
                        <td>10</td>
                        <td>3649</td>
                        <td>14991</td
                      </tr>
                      <tr>
                        <td>50</td>
                        <td>20878</td>
                        <td>78703</td>
                      </tr>
                      <tr>
                        <td>100</td>
                        <td>41552</td>
                        <td>158174</td>
                      </tr>
                    <tbody>
                  </table>
                </section>

                <section>
                  <h2>Investigate</h2>
                  <pre><code data-trim class="java">
                    http-nio-10500-exec-17" #2594 daemon prio=5 os_prio=0 tid=0x00007fdf4c0f4800 nid=0x340a waiting for monitor entry [0x00007fde8a89b000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at groovy.lang.ExpandoMetaClass.performOperationOnMetaClass(ExpandoMetaClass.java:815)
	- locked <0x000000066516d480> (a groovy.lang.ExpandoMetaClass)
	at groovy.lang.ExpandoMetaClass.registerInstanceMethod(ExpandoMetaClass.java:879)
	at groovy.lang.ExpandoMetaClass.setProperty(ExpandoMetaClass.java:794)
	at org.codehaus.groovy.runtime.InvokerHelper.setProperty(InvokerHelper.java:195)
	at org.codehaus.groovy.runtime.ScriptBytecodeAdapter.setProperty(ScriptBytecodeAdapter.java:484)
	at script1469016640536691462225.run(script1469016640536691462225.groovy:8)
	at sun.reflect.GeneratedMethodAccessor337.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:93)
	at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:325)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1215)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1024)
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:805)
	at groovy.lang.GroovyObjectSupport.invokeMethod(GroovyObjectSupport.java:46)
	at groovy.lang.Script.invokeMethod(Script.java:80)
</code></pre>
                </section>
                <section>
                  <h2>Legacy stuff</h2>
                  <pre><code data-trim class="groovy">
                    import static org.codehaus.groovy.runtime.InvokerHelper.toMapString;
def toStr = {
     delegate.title != null ? delegate.title : delegate.uuid != null
      ? delegate.uuid : toMapString(delegate, 10)
}
java.util.LinkedHashMap.metaClass.toString = toStr
...
wrapped.run()
                  </code><pre>
                </section>
                <section>
                  <h2>Wait, what? toString?</h2>
                  <p>–ü–æ—Ä–æ–π –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –≤ —Å–∫—Ä–∏–ø—Ç–µ –∫ —Å—Ç—Ä–æ–∫–µ –≤–µ–ª–æ –∫ StackOverflow, –ø–æ—ç—Ç–æ–º—É –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º toString()</p>
                </section>
                <section>
                  <h2>fix legacy</h2>
                  <pre><code data-trim class="groovy" contenteditable>
                    import static org.codehaus.groovy.runtime.InvokerHelper.toMapString;
class Init{
    static
    {
       def toStr =
       {
           delegate.title != null ? delegate.title : delegate.uuid
           != null ? delegate.uuid : toMapString(delegate, 10)
       }
       java.util.LinkedHashMap.metaClass.toString = toStr
       ...
    }
}
new Init()
wrapped.run();
</code></pre>
</section>
                <section>
                  <h2>Test again</h2>
                  <table>
                    <thead>
                      <th>Threads</th>
                      <th>JSR223</th>
                      <th>GroovyShell + legacy fix</th>
                    </thead>
                    <tbody>
                      <tr>
                        <td>10</td>
                        <td>3649</td>
                        <td>2752</td
                      </tr>
                      <tr>
                        <td>50</td>
                        <td>20878</td>
                        <td>15032</td>
                      </tr>
                      <tr>
                        <td>100</td>
                        <td>41552</td>
                        <td>30263</td>
                      </tr>
                    <tbody>
                  </table>
                </section>
                <section>
                  <h2>Alrighty!</h2>
                  <ul>
                    <li class="fragment">JSR223 away!
                    <li class="fragment">Faster!
                    <li class="fragment"><font color="red">Groovy still leaks  (‚ïØ¬∞‚ñ°¬∞Ôºâ‚ïØÔ∏µ ‚îª‚îÅ‚îª</font>
                  </ul>
                </section>
                <section>
                  <h2>Why?!</h2>
                  Groovy - –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π, –∏ –∑–Ω–∞–µ—Ç –≤—Å—ë
                  <ul>
                    <li class="fragment">–û –≤—Å–µ—Ö –∫–ª–∞—Å—Å–∞—Ö</li>
                    <li class="fragment">–û –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö –∫–ª–∞—Å—Å–æ–≤</li>
                  </ul>
                </section>
                <section>
                  <h3>org.codehaus.groovy.reflection.ClassInfo</h3>
                  <pre><code class="java">
              public class ClassInfo {
                ...
                private final Class klazz; //–∫–ª–∞—Å—Å —Å–∫—Ä–∏–ø—Ç–∞
                private MetaClass strongMetaClass;//–∑–Ω–∞–µ—Ç –≤—Å–µ –º–µ—Ç–æ–¥—ã
                private ManagedReference&ltMetaClass&gt weakMetaClass;
                ...
              }
                  </code></pre>
                  <p class="fragment">–•—Ä–∞–Ω–∏—Ç—Å—è –≤—Å—ë —ç—Ç–æ –≤ GroovyClassValue</p>
                </section>
                <section>
                  <h2>Repercussion</h2>
                  <img src="img/alotScriptClasses.png">
                  <p>–í –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ 3300 —Ç–∞–∫–∏—Ö</p>
                </section>
                <section>
                  <h2>Repercussion</h2>
                  <img src="img/scriptClassInfo.png">
                </section>
                <section>
                  <h2>Repercussion</h2>
                  <img src="img/cachedMethod.png">
                </section>

                <section>
                  <h2>Groovy templates</h2>
                  <pre style="font-size:26pt"><code data-trim class=groovy>
def bindings = ['userName':'DC#2017']
print new SimpleTemplateEngine()
.createTemplate('Hello, ${userName}')
.make(bindings)
                  </code></pre>
                </section>
                <section>
                  <h2>Template under the hood</h2>
                  <pre><code data-trim class="groovy">
public class SimpleTemplateEngine {
  ...
  public Template createTemplate(Reader reader) {
        ...

        template.script = groovyShell.
        parse(script, "SimpleTemplateScript" + counter++ + ".groovy");

        ...
  }
  ...
}
                  </code></pre>
                <p class="fragment">–ù–æ–≤–µ–Ω—å–∫–∏–π –∫–ª–∞—Å—Å!</p>
                </section>
                <section>
                  <h2>In the heap</h2>
                  <img src="img/SimpleTemplate.png" />
                  <img src="img/templateClassValue.png" />
                  <p>–¢–∞–∫–∞—è –∂–µ –∫–∞—Ä—Ç–∏–Ω–∞ –∫–∞–∫ –∏ —Ä–∞–Ω–µ–µ</p>
                </section>
                <section>
                  <h2>Solution</h2>
                  <p>–ß–∏—Å—Ç–∏–º —Å—Å—ã–ª–∫–∏ —Å–∞–º–∏</p>
                  <pre><code class="java">
private void removeGroovyClass(final Class&lt?&gt scriptClass,
                            final MetaClassRegistry metaClassRegistry)
{
    metaClassRegistry.removeMetaClass(scriptClass);
    groovyGlobalClassValue.remove(scriptClass);
    Introspector.flushFromCaches(scriptClass);
}
                  </code></pre>
                  <p class="fragment">–ò –∂–¥–µ–º —Ñ–∏–∫—Å–∞ –æ—Ç Groovy</p>
                </section>
                <section>
                  <h2>Groovy fixed it!</h2>
                    <p>Issue report date: <b>23/11/2015</b></p>
                    <p class="fragment">Issue resolve date: <b>11/09/2016</b></p>
                    <p class="fragment">Version(2.4.8) with fix: <b>13/01/2017</b></p>
                </section>
                <section>
                  <h2>JSFlight experience</h2>
                </section>
                <section>
                  <h2>JSFlight</h2>
                  <ul>
                  <li class="fragment">GStringTemplateEngine –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ URL
                  <li class="fragment">30G –ø–∞–º—è—Ç–∏ –≤–∏—Ä—Ç—É–∞–ª–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –∑–∞–ø—É—â–µ–Ω —Å–µ—Ä–≤–µ—Ä
                  <li class="fragment">–ó–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã —Å–æ–∑–¥–∞–µ—Ç—Å—è 30 –º–∏–ª–ª–∏–æ–Ω–æ–≤ –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤
                  <li class="fragment">Velocity saves the day!
                  <li class="fragment">–¢–µ–ø–µ—Ä—å —É –≤–∏—Ä—Ç—É–∞–ª–∫–∏ 3G –ø–∞–º—è—Ç–∏
                  </ul>
                </section>
                <section>
                  <h1>THX!</h1>
                  <h3><a href="http://bit.ly/GroovierSD">http://bit.ly/GroovierSD</a></h3>
                </section>
            </div>
        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>

            // Full list of configuration options available at:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: false,
                progress: true,
                history: true,
                center: true,
                slideNumber: true,

                transition: 'slide', // none/fade/slide/convex/concave/zoom

                // Optional reveal.js plugins
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true },
                    { src: 'plugin/notes/notes.js', async: true }
                ]
            });

        </script>

    </body>
</html>
